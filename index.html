<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>สถานะการตรวจจับวัตถุ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e9f0f5;
      text-align: center;
      padding-top: 100px;
    }

    .status-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      margin: 0 auto;
      background-color: gray;
      transition: background-color 0.5s;
    }

    .green { background-color: #4CAF50; }
    .red { background-color: #F44336; }

    .label {
      margin-top: 20px;
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    .sensor-status {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      font-size: 16px;
    }

    .sensor-circle {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: gray;
      margin-right: 10px;
      transition: background-color 0.5s;
    }

    .online { background-color: #2196F3; }

    .timestamp {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>

  <div id="circle" class="status-circle"></div>
  <div id="label" class="label">กำลังโหลด...</div>

  <div class="sensor-status">
    <div id="sensorIndicator" class="sensor-circle"></div>
    <span id="sensorLabel">กำลังโหลดเซนเซอร์...</span>
  </div>

  <div id="timestamp" class="timestamp"></div>

  <script>
    const apiKey = "AIzaSyB1pWGTcnbwL78fWgmVuUTi-kZ_qpjZze0";
    const sheetId = "1-XE3bUaqAlEghhtvzgnvrCrIK74zZ8hCfPqVJDJUlj4";
    const sheetName = "Test";
    const url = `https://sheets.googleapis.com/v4/spreadsheets/1-XE3bUaqAlEghhtvzgnvrCrIK74zZ8hCfPqVJDJUlj4/values/Test!B4:C4?key=AIzaSyB1pWGTcnbwL78fWgmVuUTi-kZ_qpjZze0`;

    let lastValues = { C2: null, C3: null, C4: null };

    function isNumeric(val) {
      return !isNaN(parseFloat(val)) && isFinite(val);
    }

    function fetchData() {
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const rows = data.values;
          if (!rows || rows.length < 1 || rows[0].length < 4) {
            updateUI("ไม่พบข้อมูล", "gray", false, "");
            setTimeout(() => location.reload(), 1000);
            return;
          }

          const [b4, c2, c3, c4] = rows[0];
          const timestampEl = document.getElementById("timestamp");
          timestampEl.textContent = b4 ? `อัปเดตล่าสุด: ${b4}` : "";

          // เซนเซอร์สถานะ
          const sensorOnline = b4 && b4.trim() !== "";
          const sensorIndicator = document.getElementById("sensorIndicator");
          const sensorLabel = document.getElementById("sensorLabel");
          sensorIndicator.className = "sensor-circle" + (sensorOnline ? " online" : "");
          sensorLabel.textContent = sensorOnline ? "เซนเซอร์ออนไลน์" : "เซนเซอร์ออฟไลน์";

          const isAnyEmpty = !c2 || !c3 || !c4;
          const isAnyInvalid = [c2, c3, c4].some(val => !isNumeric(val));

          if (isAnyEmpty) {
            updateUI("ไม่พบข้อมูล", "gray", sensorOnline, b4);
            setTimeout(() => location.reload(), 1000);
          } else if (isAnyInvalid) {
            updateUI("ข้อมูลไม่ถูกต้อง", "gray", sensorOnline, b4);
            setTimeout(() => location.reload(), 1000);
          } else {
            const numC2 = Number(c2);
            const numC3 = Number(c3);
            const numC4 = Number(c4);

            if (
              lastValues.C2 !== null &&
              (lastValues.C2 !== numC2 || lastValues.C3 !== numC3 || lastValues.C4 !== numC4)
            ) {
              location.reload(); // รีเฟรชเมื่อข้อมูลตัวเลขเปลี่ยน
            }

            lastValues = { C2: numC2, C3: numC3, C4: numC4 };

            if (numC2 === 12 && numC3 > 25 && numC4 === 12) {
              updateUI("ไม่พบวัตถุ", "green", sensorOnline, b4);
            } else if (numC2 < 12 && numC3 <= 25 && numC4 < 12) {
              updateUI("ตรวจพบวัตถุ!", "red", sensorOnline, b4);
            } else {
              updateUI("ข้อมูลไม่ตรงเงื่อนไข", "gray", sensorOnline, b4);
            }
          }
        })
        .catch(err => {
          console.error("Error loading data:", err);
          updateUI("เกิดข้อผิดพลาด", "gray", false, "");
          setTimeout(() => location.reload(), 1000);
        });
    }

    function updateUI(message, colorClass, online, timestamp) {
      const circle = document.getElementById("circle");
      const label = document.getElementById("label");
      const sensorIndicator = document.getElementById("sensorIndicator");
      const sensorLabel = document.getElementById("sensorLabel");
      const timestampEl = document.getElementById("timestamp");

      circle.className = `status-circle ${colorClass}`;
      label.textContent = message;
      sensorIndicator.className = "sensor-circle" + (online ? " online" : "");
      sensorLabel.textContent = online ? "เซนเซอร์ออนไลน์" : "เซนเซอร์ออฟไลน์";
      timestampEl.textContent = timestamp ? `อัปเดตล่าสุด: ${timestamp}` : "";
    }

    fetchData();
    setInterval(fetchData, 15000); // ตรวจข้อมูลทุก 15 วินาที
  </script>
</body>
</html>
